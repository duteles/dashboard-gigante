<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZinapDash</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0f1116;
      --card:#141823;
      --stroke:rgba(255,255,255,.07);
      --text:#f3f4f6;
      --muted:rgba(243,244,246,.62);

      --red:#E60000;
      --blue:#3b82f6;
      --green:#22c55e;
      --yellow:#facc15;
      --purple:#a855f7;

      --radius:18px;
      --shadow:0 18px 46px rgba(0,0,0,.55);

      --chart-card-h: 430px;
      --chart-h: 260px;

      --gap: 12px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(circle at top, #1a1e28, #0f1116 56%, #0b0c10 95%);
      color:var(--text);
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      -webkit-font-smoothing: antialiased;
      padding: 12px;
    }
    .app{ max-width: 980px; margin: 0 auto; }

    header{
      display:flex; align-items:center; gap:12px;
      margin-bottom: 10px;
    }
    .logo{
      width: 50px; height: 50px; border-radius: 999px;
      display:grid; place-items:center; font-weight:900; letter-spacing:.02em;
      background: radial-gradient(circle at 25% 20%, #8ab4ff, var(--blue) 55%, #0b2b66 100%);
      box-shadow: 0 0 25px rgba(59,130,246,.30);
      user-select:none;
    }
    .headtxt h1{ margin:0; font-size: 1.02rem; }
    .headtxt .sub{ margin-top:2px; font-size:.72rem; color:var(--muted); }

    .topbar{
      background:
        radial-gradient(circle at top left, rgba(59,130,246,.10), transparent 55%),
        radial-gradient(circle at top right, rgba(230,0,0,.10), transparent 55%),
        linear-gradient(150deg, rgba(14,16,22,.96), rgba(12,14,18,.92));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px;
      margin-bottom: var(--gap);
    }
    .toprow{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .selector{
      display:flex; gap:8px; align-items:center;
      flex-wrap: wrap;
    }

    select{
      appearance: none;
      background: rgba(8,10,14,.6);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: .80rem;
      outline:none;
    }
    .btns{ display:flex; gap:8px; align-items:center; }
    .btn{
      border:none;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 10px;
      font-size:.78rem;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      user-select:none;
      display:inline-flex; align-items:center; gap:6px;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.08); }

    .card{
      background:
        radial-gradient(circle at top left, rgba(230,0,0,.08), transparent 55%),
        radial-gradient(circle at top right, rgba(59,130,246,.06), transparent 55%),
        linear-gradient(150deg, rgba(16,20,30,.96), rgba(12,14,18,.92));
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      margin-bottom: var(--gap);
      overflow: hidden;
    }

    .chartCard{
      height: var(--chart-card-h);
      display:flex;
      flex-direction: column;
      gap: 10px;
    }

    .cardtitle{
      display:flex; justify-content: space-between; align-items:flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }
    .cardtitle h2{ margin:0; font-size: .92rem; letter-spacing:.02em; }
    .cardtitle .right{
      font-size:.72rem; color: var(--muted);
      text-align:right;
      white-space: nowrap;
    }

    .goalCard{
      background:
        radial-gradient(circle at top left, rgba(59,130,246,.16), transparent 55%),
        linear-gradient(150deg, rgba(15,23,42,.98), rgba(12,14,18,.92));
      border: 1px solid rgba(148,163,184,.25);
    }
    .goalTop{
      display:flex; justify-content: space-between; align-items:center;
      gap:10px; flex-wrap: wrap;
    }
    .goalTitle{
      font-size:.70rem; letter-spacing:.10em; text-transform: uppercase;
      color: rgba(243,244,246,.88);
      margin-bottom: 4px;
    }
    .goalText{ font-size:.72rem; color: rgba(243,244,246,.75); }

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      border-radius: 999px;
      padding: 6px 10px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      font-size:.72rem;
      color: rgba(243,244,246,.80);
      white-space: nowrap;
    }
    .dot{
      width: 8px; height: 8px; border-radius:999px;
      background: var(--green);
      box-shadow: 0 0 10px rgba(34,197,94,.55);
    }

    .progressWrap{ margin-top: 10px; }
    .progressLabel{
      display:flex; justify-content: space-between;
      font-size:.70rem; color: rgba(243,244,246,.62);
    }
    .bar{
      margin-top:6px;
      width:100%;
      height:8px;
      background: rgba(255,255,255,.06);
      border-radius: 999px;
      overflow:hidden;
      position: relative;
    }
    .fill{
      height:100%;
      width:0%;
      border-radius: inherit;
      transition: width .25s ease;
      background: linear-gradient(90deg, rgba(59,130,246,.95), rgba(34,197,94,.85));
    }

    .kpiRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .kpi{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 10px;
      text-align:center;
      min-width:0;
    }
    .kpi .lab{
      font-size:.60rem;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(243,244,246,.55);
      margin-bottom: 6px;
    }
    .kpi .val{
      font-size: 1.00rem;
      font-weight: 900;
      line-height: 1.05;
    }
    .kpi .sub{
      font-size:.68rem;
      color: var(--muted);
      margin-top: 4px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .chartWrap{
      flex: 1;
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 8px;
      display:flex;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
      position: relative;
    }
    .chartArea{
      height: var(--chart-h);
      position: relative;
      min-height: 0;
    }
    canvas{
      width:100% !important;
      height:100% !important;
      display:block;
    }

    .weekLabels{
      position: relative;
      height: 50px;
      margin-top: -2px;
      user-select:none;
    }

    .dayPill{
      position:absolute;
      top: 0;
      bottom: 0;
      padding: 4px 1px;
      text-align:center;
      border-radius: 6px;
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      min-width: 0;
      cursor:pointer;
      display:flex;
      flex-direction: column;
      justify-content: center;
      gap: 3px;
      overflow:hidden;
      transition: opacity .12s ease, transform .10s ease, border-color .10s ease, background .10s ease;
    }
    .dayPill:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .dayPill .d{
      font-size:.52rem;
      letter-spacing:.07em;
      text-transform: uppercase;
      color: rgba(243,244,246,.52);
      line-height:1.05;
      white-space: nowrap;
    }
    .dayPill .n{
      font-weight: 900;
      font-size: .84rem;
      line-height:1;
      white-space: nowrap;
    }
    .dayPill.isFocus{
      border-color: rgba(59,130,246,.75);
      background: linear-gradient(145deg, rgba(59,130,246,.14), rgba(0,0,0,.10));
      box-shadow: 0 0 0 1px rgba(59,130,246,.16) inset;
    }
    .dayPill.isOut{
      opacity: .38;
      cursor: default;
    }

    .hoverTip{
      position: fixed;
      z-index: 9999;
      pointer-events: none;
      opacity: 0;
      transform: translateY(6px);
      transition: opacity .10s ease, transform .10s ease;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(10,12,16,.92);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 48px rgba(0,0,0,.55);
      color: rgba(243,244,246,.92);
      font-size: .72rem;
      letter-spacing: .01em;
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      white-space: nowrap;
    }
    .hoverTip.show{
      opacity: 1;
      transform: translateY(0);
    }

    .metricsTop{
      display:flex;
      justify-content: space-between;
      align-items:flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }
    .bigMoney{
      font-weight: 950;
      font-size: 1.16rem;
      margin-top: 2px;
    }
    .smallMuted{
      font-size:.72rem;
      color: var(--muted);
    }
    .metricsGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .metric{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 10px;
      min-width:0;
    }
    .metric .mLab{
      font-size:.60rem;
      letter-spacing:.10em;
      text-transform: uppercase;
      color: rgba(243,244,246,.55);
      margin-bottom: 6px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .metric .mVal{
      font-size: .96rem;
      font-weight: 900;
      line-height: 1.05;
    }
    .metric .mSub{
      margin-top: 6px;
      font-size:.70rem;
      color: var(--muted);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* agora 4 caixas */
    .yearTotals{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 10px;
    }
    .yearBox{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 10px;
      min-width:0;
    }
    .yearBox .top{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom: 6px;
      color: rgba(243,244,246,.70);
      font-size:.70rem;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .yearDot{
      width: 10px; height: 10px; border-radius:999px;
      flex: 0 0 auto;
    }
    .yearBox .val{
      font-size: .98rem;
      font-weight: 900;
      line-height: 1.1;
    }
    .yearBox .sub{
      margin-top: 6px;
      font-size:.70rem;
      color: rgba(243,244,246,.50);
    }

    .growthLine{
      margin-top: 8px;
      font-size: .72rem;
      color: rgba(243,244,246,.70);
      display:flex;
      align-items:center;
      gap:8px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .growthLine .gdot{
      width: 9px; height: 9px; border-radius:999px;
      flex: 0 0 auto;
      box-shadow: 0 0 12px rgba(34,197,94,.28);
    }
    .growthLine.pos{ color: rgba(34,197,94,.92); }
    .growthLine.pos .gdot{ background: rgba(34,197,94,.95); }
    .growthLine.neg{ color: rgba(239,68,68,.92); }
    .growthLine.neg .gdot{ background: rgba(239,68,68,.95); box-shadow: 0 0 12px rgba(239,68,68,.22); }

    @media (max-width: 760px){
      .yearTotals{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 520px){
      :root{
        --chart-card-h: 455px;
        --chart-h: 290px;
      }
      .yearTotals{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="app">

    <header>
      <div class="logo">Z</div>
      <div class="headtxt">
        <h1>ZinapDash</h1>
        <div class="sub">Gigante Pneus ‚Ä¢ Ribeir√£o Preto</div>
      </div>
    </header>

    <div class="topbar">
      <div class="toprow">
        <div class="selector">
          <select id="yearSelect"></select>
          <select id="monthSelect"></select>
          <div class="btns">
            <button class="btn" id="prevMonth">‚Üê M√™s</button>
            <button class="btn" id="nextMonth">M√™s ‚Üí</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card goalCard">
      <div class="goalTop">
        <div>
          <div class="goalTitle">Meta di√°ria de leads</div>
          <div class="goalText" id="dailyGoalText">‚Äî</div>
        </div>
        <div class="badge">
          <span class="dot"></span>
          <span>Objetivo: <strong id="dailyGoalBadge">20</strong> leads/dia</span>
        </div>
      </div>
      <div class="progressWrap">
        <div class="progressLabel">
          <span id="dailyLeft">0% da meta</span>
          <span id="dailyRight">0 / 20</span>
        </div>
        <div class="bar"><div class="fill" id="dailyFill"></div></div>
      </div>
    </div>

    <!-- VIS√ÉO GERAL -->
    <div class="card chartCard">
      <div class="cardtitle">
        <h2>Vis√£o geral</h2>
        <div class="right" id="focusLabel">Dia em foco: ‚Äî</div>
      </div>

      <div class="selector" style="justify-content: space-between;">
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <select id="weekSelect"></select>
        </div>
        <div class="right" id="periodInfo">‚Äî</div>
      </div>

      <div class="kpiRow">
        <div class="kpi">
          <div class="lab">Leads do dia</div>
          <div class="val" id="kpiDay">0</div>
          <div class="sub" id="kpiDaySub">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="lab">Leads do m√™s</div>
          <div class="val" id="kpiMonth">0</div>
          <div class="sub" id="kpiMonthSub">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="lab">Leads do ano</div>
          <div class="val" id="kpiYear">0</div>
          <div class="sub" id="kpiYearSub">Acumulado (YTD)</div>
        </div>
      </div>

      <div class="chartWrap">
        <div class="chartArea">
          <canvas id="generalChart"></canvas>
        </div>
        <div class="weekLabels" id="weekLabels"></div>
        <div class="hoverTip" id="hoverTip"></div>
      </div>
    </div>

    <!-- EVOLU√á√ÉO DO M√äS -->
    <div class="card chartCard">
      <div class="cardtitle">
        <h2>Evolu√ß√£o do m√™s</h2>
        <div class="right" id="monthLineLabel">‚Äî</div>
      </div>

      <div class="kpiRow">
        <div class="kpi">
          <div class="lab">Total</div>
          <div class="val" id="monthTotalMini">0</div>
          <div class="sub" id="monthRangeMini">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="lab">M√©dia/semana</div>
          <div class="val" id="monthAvgWeekMini">0</div>
          <div class="sub" id="monthWeeksMini">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="lab">M√©dia/dia</div>
          <div class="val" id="monthAvgMini">0</div>
          <div class="sub" id="monthDaysMini">‚Äî</div>
        </div>
      </div>

      <div class="chartWrap">
        <div class="chartArea">
          <canvas id="monthLineChart"></canvas>
        </div>
      </div>
    </div>

    <!-- KPIS -->
    <div class="card">
      <div class="cardtitle">
        <h2>KPIS | Resultados</h2>
        <div class="right" id="growthBadge" style="display:none;"></div>
      </div>

      <div class="metricsTop">
        <div>
          <div style="font-size:.60rem; letter-spacing:.10em; text-transform:uppercase; color:rgba(243,244,246,.55);">Faturamento do m√™s</div>
          <div class="bigMoney" id="revMonth" style="color:rgba(59,130,246,.95);">R$ 0,00</div>
          <div class="smallMuted" id="revMonthSub">‚Äî</div>
        </div>
        <div style="text-align:right;">
          <div style="font-weight:900; font-size:1.06rem; margin-top:2px; color:rgba(230,0,0,.92);" id="invMonth">R$ 0,00</div>
          <div class="smallMuted">Investimento</div>
        </div>
      </div>

      <div class="metricsGrid">
        <div class="metric"><div class="mLab">Leads</div><div class="mVal" id="mLeads">0</div><div class="mSub">no m√™s</div></div>
        <div class="metric"><div class="mLab">Ticket m√©dio</div><div class="mVal" id="mTicket">R$ 0,00</div><div class="mSub">fat / vendas</div></div>
        <div class="metric"><div class="mLab">Vendas</div><div class="mVal" id="mSales">0</div><div class="mSub">no m√™s</div></div>
        <div class="metric"><div class="mLab">CAC</div><div class="mVal" id="mCAC">R$ 0,00</div><div class="mSub">inv / vendas</div></div>
        <div class="metric"><div class="mLab">CPL</div><div class="mVal" id="mCPL">R$ 0,00</div><div class="mSub">inv / leads</div></div>
        <div class="metric"><div class="mLab">ROAS</div><div class="mVal" id="mROAS">0x</div><div class="mSub">fat / inv</div></div>
        <div class="metric"><div class="mLab">Convers√£o</div><div class="mVal" id="mConv">0%</div><div class="mSub">vendas / leads</div></div>
        <div class="metric"><div class="mLab">ROI</div><div class="mVal" id="mROI">0%</div><div class="mSub">MC 15%</div></div>
      </div>

      <div class="cardtitle" style="margin-top: 12px;">
        <h2 style="font-size:.88rem;">Faturamento anual (comparativo)</h2>
        <div class="right">Atual em azul ‚Ä¢ Anterior em vermelho ‚Ä¢ Meta em verde</div>
      </div>

      <div class="chartWrap" style="margin-top:8px;">
        <div class="chartArea" style="height: 270px;">
          <canvas id="yearRevenueChart"></canvas>
        </div>
      </div>

      <div class="yearTotals">
        <div class="yearBox">
          <div class="top">
            <span class="yearDot" style="background: rgba(230,0,0,.92);"></span>
            <span id="labelPrevYear">Acumulado 2024</span>
          </div>
          <div class="val" id="sumPrev">R$ 0,00</div>
          <div class="sub" id="sumPrevSub">Acumulado at√© ‚Äî</div>
        </div>

        <div class="yearBox">
          <div class="top">
            <span class="yearDot" style="background: rgba(59,130,246,.95);"></span>
            <span id="labelCurYear">Acumulado 2025</span>
          </div>
          <div class="val" id="sumCur">R$ 0,00</div>
          <div class="sub" id="sumCurSub">Acumulado at√© ‚Äî</div>

          <div id="ytdGrowthLine" class="growthLine pos" style="display:none;">
            <span class="gdot"></span>
            <span>Taxa de cresc. = ‚Äî</span>
          </div>
        </div>

        <div class="yearBox">
          <div class="top">
            <span class="yearDot" style="background: rgba(34,197,94,.95); box-shadow:0 0 12px rgba(34,197,94,.25);"></span>
            <span id="labelProjYear">Projetado 2025</span>
          </div>
          <div class="val" id="sumProj">R$ 0,00</div>
          <div class="sub">Proje√ß√£o (m√©dia YTD)</div>
        </div>

        <!-- ‚úÖ NOVA 4¬™ CAIXA -->
        <div class="yearBox">
          <div class="top">
            <span class="yearDot" style="background: rgba(168,85,247,.95); box-shadow:0 0 12px rgba(168,85,247,.22);"></span>
            <span>MCL (p√≥s-m√≠dia)</span>
          </div>
          <div class="val" id="sumMCL">R$ 0,00</div>
          <div class="sub" id="sumMCLSub">Acumulado at√© ‚Äî</div>
        </div>
      </div>
    </div>

    <div class="card goalCard" style="background:
      radial-gradient(circle at top left, rgba(230,0,0,.14), transparent 55%),
      linear-gradient(150deg, rgba(15,17,22,.98), rgba(12,14,18,.92));
      border: 1px solid rgba(255,255,255,.06);">

      <div class="goalTop">
        <div>
          <div class="goalTitle">Resumo do m√™s</div>
          <div class="goalText" id="monthlyText">‚Äî</div>
        </div>
        <div class="badge" style="border-color: rgba(59,130,246,.35);">
          <span class="dot" style="background:var(--blue); box-shadow:0 0 12px rgba(59,130,246,.55);"></span>
          <span>Meta: <strong id="monthlyGoalBadge">600</strong> leads</span>
        </div>
      </div>

      <div class="progressWrap">
        <div class="progressLabel">
          <span id="monthlyLeft">0% da meta</span>
          <span id="monthlyRight">0 / 600</span>
        </div>
        <div class="bar">
          <div class="fill" id="monthlyFill" style="background: linear-gradient(90deg, rgba(230,0,0,.95), rgba(59,130,246,.80));"></div>
        </div>
      </div>
    </div>

  </div>

<script>
/** ‚úÖ sua URL do Apps Script */
const URL_DA_API = "https://script.google.com/macros/s/AKfycbx8fKah0OA1qD-qKtc6ZudwrMBz0BXzEeU88hZUEIoIDvsVVfGqv_4mwuOrw8FF9JuBHQ/exec";

/** cache local pra abrir ‚Äúna hora‚Äù e depois atualizar com a nuvem */
const LOCAL_CACHE_KEY = "zinapdash_cache_v1";

/** defaults (caso Config esteja vazio) */
let DAILY_GOAL = 20;
let MONTHLY_GOAL = 600;
let MARGEM_CONTRIB = 0.15;
let GROWTH_TARGET_MONTHLY = 0.03;

const GOAL_LINES = [10, 20, 30];

const dayNames = ["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"];
const monthNames = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];

let state = { entries: [], financials: {}, config: {} };
let focusDate = new Date();
let selectedWeekIndex = 0;

let generalChart, monthLineChart, yearRevenueChart;

let focusLabelCache = "";
const hoverTip = document.getElementById("hoverTip");
let previewTimer = null;

function pad2(n){ return ("0"+n).slice(-2); }
function toDateStr(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function toMonthKey(y,m){ return `${y}-${pad2(m+1)}`; }
function parseISODate(s){ const [y,m,d]=s.split("-").map(Number); return new Date(y, m-1, d); }
function formatBR(s){ const [y,m,d]=s.split("-"); return `${d}/${m}/${y}`; }
function currencyBR(v){ return (Number(v)||0).toLocaleString("pt-BR",{style:"currency", currency:"BRL"}); }
function cloneDate(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

function pctBRBounded(valueDecimal, minPct = 0.1, maxPct = 999.9) {
  if (!isFinite(valueDecimal)) return "‚Äî";
  const pct = valueDecimal * 100;
  if (pct === 0) return "0%";
  if (pct > 0 && pct < minPct) return "<0,1%";
  if (pct > maxPct) return ">999,9%";
  return pct.toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + "%";
}

function getMonthRange(year, month){
  const start = new Date(year, month, 1);
  const end = new Date(year, month+1, 0);
  return {start, end};
}
function getWeekStart(d){
  const x = cloneDate(d);
  x.setDate(x.getDate() - x.getDay());
  return x;
}
function entriesForMonth(year, month){
  return state.entries
    .filter(e=>{
      const d = parseISODate(e.date);
      return d.getFullYear()===year && d.getMonth()===month;
    })
    .sort((a,b)=> parseISODate(a.date) - parseISODate(b.date));
}
function entriesForYearUpToMonth(year, month){
  return state.entries.filter(e=>{
    const d = parseISODate(e.date);
    return d.getFullYear()===year && d.getMonth()<=month;
  });
}
function qtyOn(dateStr){
  const found = state.entries.find(e=> e.date===dateStr);
  return found ? (Number(found.qty)||0) : 0;
}
function getFinancialForMonth(year, month){
  const key = toMonthKey(year, month);
  return state.financials[key] || null;
}

function getMonthWeeks(year, month){
  const {start: mStart, end: mEnd} = getMonthRange(year, month);
  const weeks = [];
  let cursor = cloneDate(mStart);
  cursor = getWeekStart(cursor);

  while(cursor <= mEnd){
    const calStart = cloneDate(cursor);
    const calEnd = cloneDate(cursor); calEnd.setDate(calEnd.getDate()+6);

    const inStart = cloneDate(calStart < mStart ? mStart : calStart);
    const inEnd = cloneDate(calEnd > mEnd ? mEnd : calEnd);

    weeks.push({ calStart, calEnd, inStart, inEnd });
    cursor.setDate(cursor.getDate()+7);
  }
  return weeks;
}

function findWeekIndexForDate(year, month, dateObj){
  const weeks = getMonthWeeks(year, month);
  const ds = cloneDate(dateObj);
  for(let i=0;i<weeks.length;i++){
    const w = weeks[i];
    if(ds >= w.calStart && ds <= w.calEnd) return i;
  }
  return 0;
}

function isCurrentSelectedMonth(year, month){
  const now = new Date();
  return now.getFullYear() === year && now.getMonth() === month;
}

async function fetchFromApi(){
  const url = URL_DA_API + "?t=" + Date.now();
  const res = await fetch(url);
  if(!res.ok) throw new Error("fetch fail");
  const data = await res.json();

  if(data.entries && Array.isArray(data.entries)){
    state.entries = data.entries.map(e=>({date:e.date, qty:Number(e.qty)||0}));
  }
  if(data.financials && typeof data.financials === "object"){
    state.financials = data.financials;
  }
  if(data.config && typeof data.config === "object"){
    state.config = data.config;
  }

  applyConfigFromState();
  saveCache();
}

function applyConfigFromState(){
  const cfg = state.config || {};
  if(cfg.DAILY_GOAL != null) DAILY_GOAL = Number(cfg.DAILY_GOAL) || DAILY_GOAL;
  if(cfg.MONTHLY_GOAL != null) MONTHLY_GOAL = Number(cfg.MONTHLY_GOAL) || MONTHLY_GOAL;
  if(cfg.MARGEM_CONTRIB != null) MARGEM_CONTRIB = Number(cfg.MARGEM_CONTRIB) || MARGEM_CONTRIB;
  if(cfg.GROWTH_TARGET_MONTHLY != null) GROWTH_TARGET_MONTHLY = Number(cfg.GROWTH_TARGET_MONTHLY) || GROWTH_TARGET_MONTHLY;

  // atualiza label ‚ÄúMC 15%‚Äù
  document.querySelector('#mROI')?.parentElement?.querySelector('.mSub')?.textContent &&
    (document.querySelector('#mROI').parentElement.querySelector('.mSub').textContent = `MC ${(MARGEM_CONTRIB*100).toFixed(0)}%`);

  document.getElementById("dailyGoalBadge").textContent = DAILY_GOAL;
  document.getElementById("monthlyGoalBadge").textContent = MONTHLY_GOAL;
}

function saveCache(){
  try{
    localStorage.setItem(LOCAL_CACHE_KEY, JSON.stringify({
      state,
      ts: Date.now()
    }));
  }catch(e){}
}
function loadCache(){
  try{
    const raw = localStorage.getItem(LOCAL_CACHE_KEY);
    if(!raw) return false;
    const obj = JSON.parse(raw);
    if(!obj || !obj.state) return false;
    state = obj.state;
    applyConfigFromState();
    return true;
  }catch(e){ return false; }
}

const yearSelect = document.getElementById("yearSelect");
const monthSelect = document.getElementById("monthSelect");
const prevMonthBtn = document.getElementById("prevMonth");
const nextMonthBtn = document.getElementById("nextMonth");
const weekSelect = document.getElementById("weekSelect");
const periodInfo = document.getElementById("periodInfo");

function initSelectors(){
  const startYear = 2024, endYear = 2028;
  for(let y=startYear; y<= endYear; y++){
    const o=document.createElement("option");
    o.value=y; o.textContent=y;
    yearSelect.appendChild(o);
  }
  for(let m=0;m<12;m++){
    const o=document.createElement("option");
    o.value=m; o.textContent=monthNames[m];
    monthSelect.appendChild(o);
  }

  const now = new Date();
  yearSelect.value = String(now.getFullYear());
  monthSelect.value = String(now.getMonth());

  syncFocusToSelectedMonth();
  rebuildWeekSelect();
}

function getSelectedYM(){
  return { year: parseInt(yearSelect.value,10), month: parseInt(monthSelect.value,10) };
}

function syncFocusToSelectedMonth(){
  const {year, month} = getSelectedYM();
  const {start, end} = getMonthRange(year, month);

  if(isCurrentSelectedMonth(year, month)){
    const now = new Date();
    focusDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  } else {
    focusDate = new Date(end.getFullYear(), end.getMonth(), end.getDate());
  }

  if(focusDate < start) focusDate = cloneDate(start);
  if(focusDate > end) focusDate = cloneDate(end);
}

function rebuildWeekSelect(){
  const {year, month} = getSelectedYM();
  const weeks = getMonthWeeks(year, month);

  weekSelect.innerHTML = "";
  for(let i=0;i<weeks.length;i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = `${i+1}¬™ Semana`;
    weekSelect.appendChild(opt);
  }

  if(isCurrentSelectedMonth(year, month)){
    const now = new Date();
    selectedWeekIndex = clamp(findWeekIndexForDate(year, month, now), 0, weeks.length-1);
  } else {
    selectedWeekIndex = Math.max(0, weeks.length - 1);
  }

  weekSelect.value = String(selectedWeekIndex);
}

function baseYScale(){
  return {
    beginAtZero:true,
    max: 45,
    ticks:{
      stepSize: 5,
      color:"rgba(243,244,246,.42)",
      font:{ size: 11 }
    },
    grid:{ color:"rgba(255,255,255,.05)" }
  };
}

function renderDailyGoal(){
  document.getElementById("dailyGoalBadge").textContent = DAILY_GOAL;

  const ds = toDateStr(focusDate);
  const qty = qtyOn(ds);

  const pct = DAILY_GOAL > 0 ? (qty / DAILY_GOAL) * 100 : 0;
  const pctClamped = clamp(pct, 0, 100);

  document.getElementById("dailyFill").style.width = pctClamped.toFixed(0) + "%";
  document.getElementById("dailyLeft").textContent = `${Math.max(0,pct).toFixed(0)}% da meta`;
  document.getElementById("dailyRight").textContent = `${qty} / ${DAILY_GOAL}`;

  let msg;
  if(qty === 0) msg = `Dia em foco (${formatBR(ds)}): ainda sem leads.`;
  else if(pct < 50) msg = `Dia em foco (${formatBR(ds)}): ${qty} lead(s).`;
  else if(pct < 100) msg = `Dia em foco (${formatBR(ds)}): ${qty} lead(s). T√° perto.`;
  else msg = `Dia em foco (${formatBR(ds)}): meta batida! üòÑ`;
  document.getElementById("dailyGoalText").textContent = msg;
}

function positionWeekPillsToChart(chart){
  const wrap = document.getElementById("weekLabels");
  if(!wrap || !chart || !chart.scales || !chart.scales.x) return;

  const x = chart.scales.x;
  const leftEdge = chart.chartArea.left;
  const rightEdge = chart.chartArea.right;

  const pills = [...wrap.querySelectorAll(".dayPill")];
  if(pills.length !== 7) return;

  for(let i=0; i<7; i++){
    const center = x.getPixelForTick(i);

    const prevCenter = (i === 0) ? leftEdge : x.getPixelForTick(i-1);
    const nextCenter = (i === 6) ? rightEdge : x.getPixelForTick(i+1);

    const L = (i === 0) ? leftEdge : (prevCenter + center) / 2;
    const R = (i === 6) ? rightEdge : (center + nextCenter) / 2;

    pills[i].style.left = `${Math.round(L)}px`;
    pills[i].style.width = `${Math.max(18, Math.round(R - L))}px`;
  }
}

function setFocusPreview(text){
  document.getElementById("focusLabel").textContent = text;
}
function cacheFocusLabel(){
  focusLabelCache = document.getElementById("focusLabel").textContent || "";
}
function restoreFocusLabel(){
  if(focusLabelCache) document.getElementById("focusLabel").textContent = focusLabelCache;
}

function showTip(pillEl, text){
  if(!text) return;
  hoverTip.textContent = text;

  const r = pillEl.getBoundingClientRect();
  const x = r.left + r.width/2;
  const y = r.top - 10;

  hoverTip.style.left = x + "px";
  hoverTip.style.top = y + "px";
  hoverTip.style.transform = "translate(-50%, -100%)";
  hoverTip.classList.add("show");
}
function hideTip(){
  hoverTip.classList.remove("show");
}

/** ‚úÖ preview por 0,5s */
function showPreviewFor(pill, text, ms=500){
  if(!text) return;
  cacheFocusLabel();
  setFocusPreview(`Pr√©via: ${text}`);
  showTip(pill, text);

  if(previewTimer) clearTimeout(previewTimer);
  previewTimer = setTimeout(()=>{
    hideTip();
    restoreFocusLabel();
  }, ms);
}

function renderWeekLabels(weekValues, focusIndex, isOutArr, weekDatesISO){
  const wrap = document.getElementById("weekLabels");
  wrap.innerHTML = "";

  for(let i=0;i<7;i++){
    const pill = document.createElement("div");
    const isOut = !!isOutArr?.[i];
    pill.className = "dayPill" + (i===focusIndex ? " isFocus" : "") + (isOut ? " isOut" : "");
    pill.dataset.index = i;
    pill.dataset.out = isOut ? "1" : "0";

    const iso = weekDatesISO[i];
    const labelDate = iso ? formatBR(iso) : "";
    const qty = weekValues[i] || 0;

    const previewText = isOut ? "" : `${dayNames[i]} ‚Ä¢ ${labelDate}`;

    pill.innerHTML = `<div class="d">${dayNames[i]}</div><div class="n">${qty}</div>`;
    wrap.appendChild(pill);

    if(!isOut){
      pill.addEventListener("mouseenter", ()=> showPreviewFor(pill, previewText, 500));
      pill.addEventListener("click", ()=> showPreviewFor(pill, previewText, 500));
    }
  }

  wrap.onclick = (ev)=>{
    const pill = ev.target.closest(".dayPill");
    if(!pill) return;
    if(pill.dataset.out === "1") return;

    const idx = parseInt(pill.dataset.index,10);
    const iso = weekDatesISO[idx];
    if(!iso) return;

    focusDate = parseISODate(iso);
    renderAll();
  };
}

function renderGeneral(){
  const {year, month} = getSelectedYM();
  const monthEntries = entriesForMonth(year, month);
  const monthTotal = monthEntries.reduce((s,e)=>s+e.qty,0);

  const ytdEntries = entriesForYearUpToMonth(year, month);
  const yearTotal = ytdEntries.reduce((s,e)=>s+e.qty,0);

  const {start: mStart, end: mEnd} = getMonthRange(year, month);

  if(focusDate < mStart) focusDate = cloneDate(mStart);
  if(focusDate > mEnd) focusDate = cloneDate(mEnd);

  const focusStr = toDateStr(focusDate);
  document.getElementById("focusLabel").textContent = `Dia em foco: ${formatBR(focusStr)}`;
  focusLabelCache = document.getElementById("focusLabel").textContent;

  document.getElementById("kpiDay").textContent = qtyOn(focusStr);
  document.getElementById("kpiDaySub").textContent = formatBR(focusStr);

  document.getElementById("kpiMonth").textContent = monthTotal;
  document.getElementById("kpiMonthSub").textContent = `${pad2(month+1)}/${year}`;

  document.getElementById("kpiYear").textContent = yearTotal;
  document.getElementById("kpiYearSub").textContent = `Jan ‚Üí ${monthNames[month]} (${year})`;

  const weeks = getMonthWeeks(year, month);
  selectedWeekIndex = clamp(parseInt(weekSelect.value,10) || 0, 0, weeks.length-1);

  const w = weeks[selectedWeekIndex];
  periodInfo.textContent = `${formatBR(toDateStr(w.inStart))} a ${formatBR(toDateStr(w.inEnd))}`;

  const weekValues = [];
  const isOutArr = [];
  const weekDatesISO = [];

  for(let i=0;i<7;i++){
    const d = cloneDate(w.calStart);
    d.setDate(w.calStart.getDate()+i);
    const ds = toDateStr(d);

    const out = (d < mStart || d > mEnd);
    isOutArr.push(out);
    weekDatesISO.push(ds);
    weekValues.push(out ? 0 : qtyOn(ds));
  }

  const focusDow = focusDate.getDay();

  if(generalChart) generalChart.destroy();
  const ctx = document.getElementById("generalChart").getContext("2d");

  generalChart = new Chart(ctx,{
    type:"bar",
    data:{
      labels: dayNames,
      datasets:[
        {
          data: weekValues,
          backgroundColor: weekValues.map((_, idx)=> idx===focusDow ? "rgba(59,130,246,.88)" : "rgba(230,0,0,.78)"),
          borderRadius: 7,
          borderSkipped: false,
          categoryPercentage: 1.0,
          barPercentage: 0.70
        },
        { type:"line", data: dayNames.map(()=>GOAL_LINES[0]), borderColor:"rgba(250,204,21,.75)", borderDash:[6,4], borderWidth:1.1, pointRadius:0 },
        { type:"line", data: dayNames.map(()=>GOAL_LINES[1]), borderColor:"rgba(34,197,94,.70)", borderDash:[6,4], borderWidth:1.1, pointRadius:0 },
        { type:"line", data: dayNames.map(()=>GOAL_LINES[2]), borderColor:"rgba(59,130,246,.60)", borderDash:[6,4], borderWidth:1.1, pointRadius:0 }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      plugins:{ legend:{ display:false }, tooltip:{ filter:(i)=> i.datasetIndex===0 } },
      scales:{
        x:{ grid:{ display:false }, ticks:{ display:false }, offset:true },
        y: baseYScale()
      },
      onClick:(evt, elements)=>{
        if(!elements.length) return;
        const idx = elements[0].index;
        if(isOutArr[idx]) return;
        focusDate = parseISODate(weekDatesISO[idx]);
        renderAll();
      }
    }
  });

  renderWeekLabels(weekValues, focusDow, isOutArr, weekDatesISO);

  requestAnimationFrame(()=> positionWeekPillsToChart(generalChart));
  setTimeout(()=> positionWeekPillsToChart(generalChart), 60);
}

function calcAvgPerWeekInMonth(year, month){
  const weeks = getMonthWeeks(year, month);
  const {start: mStart, end: mEnd} = getMonthRange(year, month);

  const totals = weeks.map(w=>{
    let sum = 0;
    for(let i=0;i<7;i++){
      const d = cloneDate(w.calStart);
      d.setDate(w.calStart.getDate()+i);
      if(d < mStart || d > mEnd) continue;
      sum += qtyOn(toDateStr(d));
    }
    return sum;
  });

  const count = totals.length || 1;
  const avg = totals.reduce((s,v)=>s+v,0) / count;
  return { avg, count };
}

function renderMonthLine(){
  const {year, month} = getSelectedYM();
  const {start, end} = getMonthRange(year, month);

  const labels = [];
  const values = [];

  for(let d=cloneDate(start); d<=end; d.setDate(d.getDate()+1)){
    const ds = toDateStr(d);
    labels.push(formatBR(ds));
    values.push(qtyOn(ds));
  }

  const total = values.reduce((s,v)=>s+v,0);
  const days = values.length;
  const avgDay = days ? (total/days) : 0;

  const { avg: avgWeek, count: weekCount } = calcAvgPerWeekInMonth(year, month);

  document.getElementById("monthLineLabel").textContent = `01/${pad2(month+1)}/${year} ‚Üí ${pad2(end.getDate())}/${pad2(month+1)}/${year}`;
  document.getElementById("monthTotalMini").textContent = total;
  document.getElementById("monthRangeMini").textContent = `${formatBR(toDateStr(start))} a ${formatBR(toDateStr(end))}`;

  document.getElementById("monthAvgWeekMini").textContent = avgWeek.toFixed(1).replace(".",",");
  document.getElementById("monthWeeksMini").textContent = `${weekCount} semana(s)`;

  document.getElementById("monthAvgMini").textContent = avgDay.toFixed(1).replace(".",",");
  document.getElementById("monthDaysMini").textContent = `${days} dia(s)`;

  if(monthLineChart) monthLineChart.destroy();
  const ctx = document.getElementById("monthLineChart").getContext("2d");

  monthLineChart = new Chart(ctx,{
    type:"line",
    data:{
      labels,
      datasets:[
        {
          data: values,
          borderColor:"rgba(230,0,0,.92)",
          backgroundColor:"rgba(230,0,0,.18)",
          tension:.32,
          fill:true,
          pointRadius: 3,
          pointHoverRadius: 5,
          pointBackgroundColor: "rgba(0,0,0,0)",
          pointBorderColor: "rgba(59,130,246,.35)",
          pointBorderWidth: 2
        },
        { data: labels.map(()=>GOAL_LINES[0]), borderColor:"rgba(250,204,21,.72)", borderDash:[6,4], borderWidth:1.1, pointRadius:0, fill:false },
        { data: labels.map(()=>GOAL_LINES[1]), borderColor:"rgba(34,197,94,.70)", borderDash:[6,4], borderWidth:1.1, pointRadius:0, fill:false },
        { data: labels.map(()=>GOAL_LINES[2]), borderColor:"rgba(59,130,246,.62)", borderDash:[6,4], borderWidth:1.1, pointRadius:0, fill:false }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      plugins:{ legend:{ display:false }, tooltip:{ filter:(i)=> i.datasetIndex===0 } },
      scales:{
        x:{ grid:{ display:false }, ticks:{ color:"rgba(243,244,246,.52)", font:{ size: 10 }, maxRotation: 55, minRotation: 55 } },
        y: baseYScale()
      }
    }
  });
}

function renderIndicatorsAndRevenueYear(){
  const {year, month} = getSelectedYM();
  const monthEntries = entriesForMonth(year, month);
  const leads = monthEntries.reduce((s,e)=>s+e.qty,0);

  const fin = getFinancialForMonth(year, month);

  const ticket = fin?.ticket ?? 0;
  const sales = fin?.sales ?? 0;
  const revenue = fin?.revenue ?? 0;
  const spend = fin?.spend ?? 0;

  const cpl = leads > 0 ? spend / leads : 0;
  const cac = sales > 0 ? spend / sales : 0;

  const roas = spend > 0 ? revenue / spend : 0;

  const lucroContrib = revenue * MARGEM_CONTRIB;
  const roi = spend > 0 ? ((lucroContrib - spend) / spend) : 0;

  const convPct = leads > 0 ? (sales / leads) : 0;

  document.getElementById("revMonth").textContent = currencyBR(revenue);
  document.getElementById("revMonthSub").textContent = `M√™s selecionado: ${pad2(month+1)}/${year}`;
  document.getElementById("invMonth").textContent = currencyBR(spend);

  document.getElementById("mLeads").textContent = leads;
  document.getElementById("mTicket").textContent = ticket ? currencyBR(ticket) : "‚Äî";
  document.getElementById("mSales").textContent = sales || 0;
  document.getElementById("mCAC").textContent = sales ? currencyBR(cac) : "‚Äî";
  document.getElementById("mCPL").textContent = leads ? currencyBR(cpl) : "‚Äî";
  document.getElementById("mROAS").textContent = spend ? `${roas.toFixed(1).replace(".",",")}x` : "‚Äî";
  document.getElementById("mConv").textContent = leads ? `${(convPct*100).toFixed(0)}%` : "‚Äî";
  document.getElementById("mROI").textContent = spend ? pctBRBounded(roi) : "‚Äî";

  const curYear = year;
  const prevYear = year - 1;

  const cur = [];
  const prev = [];
  for(let m=0; m<12; m++){
    const keyCur = `${curYear}-${String(m+1).padStart(2,"0")}`;
    const keyPrev = `${prevYear}-${String(m+1).padStart(2,"0")}`;
    cur.push(Number(state.financials[keyCur]?.revenue ?? 0));
    prev.push(Number(state.financials[keyPrev]?.revenue ?? 0));
  }

  // ‚úÖ YTD correto (at√© o m√™s selecionado)
  const ytdCur = cur.slice(0, month+1).reduce((s,v)=>s+v,0);
  const ytdPrev = prev.slice(0, month+1).reduce((s,v)=>s+v,0);

  const growth = ytdPrev > 0 ? ((ytdCur - ytdPrev)/ytdPrev) : 0;
  const gPct = (growth*100).toFixed(1).replace(".",",");

  const target = prev.map((v, idx)=>{
    const factor = Math.pow(1 + GROWTH_TARGET_MONTHLY, idx + 1);
    return Math.round(v * factor);
  });

  const monthsSoFar = (month + 1);
  const avgSoFar = monthsSoFar > 0 ? (ytdCur / monthsSoFar) : 0;
  const projectedCur = Math.round(avgSoFar * 12);

  // ‚úÖ Crescimento no box do ano atual
  const yLine = document.getElementById("ytdGrowthLine");
  if(yLine){
    yLine.style.display = "flex";
    const isPos = growth >= 0;
    yLine.classList.remove("pos","neg");
    yLine.classList.add(isPos ? "pos" : "neg");
    yLine.innerHTML = `<span class="gdot"></span><span>Taxa de cresc. = ${isPos?"+":""}${gPct}% ano</span>`;
  }

  document.getElementById("labelPrevYear").textContent = `Acumulado ${prevYear}`;
  document.getElementById("labelCurYear").textContent = `Acumulado ${curYear}`;
  document.getElementById("labelProjYear").textContent = `Projetado ${curYear}`;

  // ‚úÖ sub: acumulado at√© m√™s selecionado
  const untilTxt = `Acumulado at√© ${monthNames[month]}`;
  document.getElementById("sumPrevSub").textContent = untilTxt;
  document.getElementById("sumCurSub").textContent = untilTxt;

  document.getElementById("sumPrev").textContent = currencyBR(ytdPrev);
  document.getElementById("sumCur").textContent = currencyBR(ytdCur);
  document.getElementById("sumProj").textContent = currencyBR(projectedCur);

  // ‚úÖ MCL (p√≥s-m√≠dia) YTD = Œ£( receita*MC - investimento )
  let mclYtd = 0;
  for(let mm=0; mm<=month; mm++){
    const key = `${curYear}-${String(mm+1).padStart(2,"0")}`;
    const rev = Number(state.financials[key]?.revenue ?? 0);
    const sp  = Number(state.financials[key]?.spend ?? 0);
    mclYtd += (rev * MARGEM_CONTRIB) - sp;
  }
  document.getElementById("sumMCL").textContent = currencyBR(mclYtd);
  document.getElementById("sumMCLSub").textContent = untilTxt;

  // gr√°fico anual
  if(yearRevenueChart) yearRevenueChart.destroy();
  const ctx = document.getElementById("yearRevenueChart").getContext("2d");

  yearRevenueChart = new Chart(ctx,{
    type:"line",
    data:{
      labels: monthNames,
      datasets:[
        {
          label: String(curYear),
          data: cur,
          borderColor:"rgba(59,130,246,.95)",
          tension:.28,
          fill:false,
          pointRadius:2,
          pointHoverRadius:4,
          pointBackgroundColor:"rgba(0,0,0,0)",
          pointBorderColor:"rgba(59,130,246,.55)",
          pointBorderWidth:2
        },
        {
          label: String(prevYear),
          data: prev,
          borderColor:"rgba(230,0,0,.92)",
          tension:.28,
          fill:false,
          pointRadius:2,
          pointHoverRadius:4,
          pointBackgroundColor:"rgba(0,0,0,0)",
          pointBorderColor:"rgba(230,0,0,.55)",
          pointBorderWidth:2
        },
        {
          label: "Meta",
          data: target,
          borderColor:"rgba(34,197,94,.95)",
          borderDash:[7,5],
          borderWidth:1.6,
          tension:.28,
          fill:false,
          pointRadius:0
        }
      ]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      animation:false,
      plugins:{
        legend:{
          labels:{
            color:"rgba(243,244,246,.70)",
            usePointStyle:true,
            pointStyle:"circle",
            boxWidth:8,
            boxHeight:8
          }
        },
        tooltip:{
          callbacks:{
            label:(ctx)=> ` ${ctx.dataset.label}: ${currencyBR(ctx.raw)}`
          }
        }
      },
      scales:{
        x:{ grid:{ display:false }, ticks:{ color:"rgba(243,244,246,.55)", font:{ size: 11 } } },
        y:{
          grid:{ color:"rgba(255,255,255,.05)" },
          ticks:{ color:"rgba(243,244,246,.42)", callback:(v)=> (v/1000).toFixed(0)+"k" }
        }
      }
    }
  });
}

function renderMonthlyGoal(){
  document.getElementById("monthlyGoalBadge").textContent = MONTHLY_GOAL;

  const {year, month} = getSelectedYM();
  const monthEntries = entriesForMonth(year, month);
  const total = monthEntries.reduce((s,e)=>s+e.qty,0);

  let prevYear = year, prevMonth = month - 1;
  if(prevMonth < 0){ prevMonth = 11; prevYear = year - 1; }
  const prevTotal = entriesForMonth(prevYear, prevMonth).reduce((s,e)=>s+e.qty,0);

  const pct = MONTHLY_GOAL > 0 ? (total / MONTHLY_GOAL) * 100 : 0;
  const pctClamped = clamp(pct, 0, 100);

  document.getElementById("monthlyFill").style.width = pctClamped.toFixed(0) + "%";
  document.getElementById("monthlyLeft").textContent = `${pct.toFixed(0)}% da meta`;
  document.getElementById("monthlyRight").textContent = `${total} / ${MONTHLY_GOAL}`;

  let msg = `No m√™s ${pad2(month+1)}/${year}: ${total} leads.`;
  if(prevTotal > 0){
    const diff = total - prevTotal;
    const pctDiff = (diff/prevTotal)*100;
    msg += diff >= 0
      ? ` Crescimento de +${pctDiff.toFixed(1).replace(".",",")}% vs m√™s anterior.`
      : ` Queda de ${pctDiff.toFixed(1).replace(".",",")}% vs m√™s anterior.`;
  }
  document.getElementById("monthlyText").textContent = msg;
}

function renderAll(){
  renderGeneral();
  renderDailyGoal();
  renderMonthLine();
  renderIndicatorsAndRevenueYear();
  renderMonthlyGoal();
}

yearSelect.addEventListener("change", ()=>{
  syncFocusToSelectedMonth();
  rebuildWeekSelect();
  renderAll();
});
monthSelect.addEventListener("change", ()=>{
  syncFocusToSelectedMonth();
  rebuildWeekSelect();
  renderAll();
});
prevMonthBtn.addEventListener("click", ()=>{
  let y = parseInt(yearSelect.value,10);
  let m = parseInt(monthSelect.value,10);
  m--;
  if(m<0){ m=11; y--; }
  yearSelect.value = y;
  monthSelect.value = m;
  syncFocusToSelectedMonth();
  rebuildWeekSelect();
  renderAll();
});
nextMonthBtn.addEventListener("click", ()=>{
  let y = parseInt(yearSelect.value,10);
  let m = parseInt(monthSelect.value,10);
  m++;
  if(m>11){ m=0; y++; }
  yearSelect.value = y;
  monthSelect.value = m;
  syncFocusToSelectedMonth();
  rebuildWeekSelect();
  renderAll();
});
weekSelect.addEventListener("change", ()=>{
  selectedWeekIndex = parseInt(weekSelect.value,10) || 0;
  renderAll();
});

window.addEventListener("resize", ()=>{
  hideTip();
  if(generalChart){
    requestAnimationFrame(()=> positionWeekPillsToChart(generalChart));
  }
});

(async function init(){
  initSelectors();

  // abre r√°pido com cache
  const hadCache = loadCache();
  if(hadCache){
    syncFocusToSelectedMonth();
    rebuildWeekSelect();
    renderAll();
  }

  // depois atualiza com nuvem
  try{
    await fetchFromApi();
    syncFocusToSelectedMonth();
    rebuildWeekSelect();
    renderAll();
  }catch(e){
    // se falhar, fica com o que tiver em cache
    if(!hadCache){
      // sem cache e sem nuvem: render vazio
      renderAll();
    }
  }
})();
</script>
</body>
</html>
